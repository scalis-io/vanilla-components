cubes:
  - name: survey_form_question_answer
    # sql_table: survey_form_question_answer
    sql: |
      SELECT
        a.*,
        COALESCE(opt.value, NULL) AS multiple_select_value
      FROM survey_form_question_answer a
      LEFT JOIN LATERAL (
        SELECT jsonb_array_elements_text(a.answer -> 'selectedOptions') AS value
      ) AS opt ON (a.answer ->> 'type') = 'MULTIPLE_SELECT'
    joins:
      - name: survey_form_question_template
        sql: '{CUBE}.survey_form_question_template_id = {survey_form_question_template}.id'
        relationship: many_to_one
      - name: survey_form
        sql: '{CUBE}.survey_form_id = {survey_form}.id'
        relationship: many_to_one
    measures:
      - name: count
        type: count
    dimensions:
      - name: id
        sql: id
        type: number
        primary_key: true
      - name: surveyformid
        sql: '{CUBE}.survey_form_id'
        type: number
      - name: surveyformquestiontemplateid
        sql: '{CUBE}.survey_form_question_template_id'
        type: number
      - name: answer
        sql: '{CUBE}.answer'
        type: string
      - name: answer_type
        sql: '{CUBE}.answer ->> "type"'
        type: string
      - name: answer_value
        sql: |
          CASE
            WHEN {CUBE}.answer ->> 'type' IN ('SHORT_ANSWER', 'PARAGRAPH', 'NUMBER_SCALE', 'NUMERICAL', 'DATE', 'URL', 'EMAIL', 'PHONE')
              THEN {CUBE}.answer ->> 'value'
            WHEN {CUBE}.answer ->> 'type' = 'YES_NO'
              THEN CASE
                WHEN lower({CUBE}.answer ->> 'selectedOption') = 'yes' THEN 'Yes'
                WHEN lower({CUBE}.answer ->> 'selectedOption') = 'no' THEN 'No'
                ELSE {CUBE}.answer ->> 'selectedOption'
              END
            WHEN {CUBE}.answer ->> 'type' = 'SINGLE_SELECT'
              THEN (
                SELECT opt ->> 'text'
                FROM survey_form_question_template,
                    jsonb_array_elements(survey_form_question_template.answer_options -> 'options') AS opt
                WHERE survey_form_question_template.id = {CUBE}.survey_form_question_template_id
                  AND opt ->> 'id' = ({CUBE}.answer ->> 'selectedOption')
                LIMIT 1
              )
            WHEN {CUBE}.answer ->> 'type' = 'MULTIPLE_SELECT'
              THEN (
                SELECT opt ->> 'text'
                FROM survey_form_question_template,
                    jsonb_array_elements(survey_form_question_template.answer_options -> 'options') AS opt
                WHERE survey_form_question_template.id = {CUBE}.survey_form_question_template_id
                  AND opt ->> 'id' = {CUBE}.multiple_select_value
                LIMIT 1
              )
            WHEN {CUBE}.answer ->> 'type' = 'RATING'
              THEN COALESCE(
                (
                  SELECT labels ->> (CAST(({CUBE}.answer ->> 'rating') AS int) - 1)
                  FROM (
                    SELECT (survey_form_question_template.answer_options -> 'labels') AS labels
                    FROM survey_form_question_template
                    WHERE survey_form_question_template.id = {CUBE}.survey_form_question_template_id
                      AND (survey_form_question_template.answer_options -> 'labels') IS NOT NULL
                    LIMIT 1
                  ) t
                ),
                {CUBE}.answer ->> 'rating'
              )
            WHEN {CUBE}.answer ->> 'type' = 'FILE_UPLOAD'
              THEN ({CUBE}.answer -> 'files' -> 0 ->> 'fileName')
            ELSE NULL
          END
        type: string
      - name: createdat
        sql: '{CUBE}.created_at'
        type: time
      - name: updatedat
        sql: '{CUBE}.updated_at'
        type: time
