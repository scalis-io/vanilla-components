cubes:
  - name: requisition_time_to_fill
    description: 'Time to fill in days for requisitions, with proper joins for department and hiring team member filters'
    sql: >
      WITH unique_openings AS (
        /* Base query with unique job openings - no duplication */
        SELECT DISTINCT ON (
          COALESCE("job_opening"."id", "requisition"."id")
        )
          "requisition"."id" AS "requisition_id",
          "requisition"."job_name" AS "job_name",
          "company_department"."department_name" AS "department_name",
          "job_opening"."id" AS "job_opening_id",
          "job_opening"."opening_status" AS "opening_status",
          "job_opening"."filled_date" AS "filled_date",
          "job_opening"."start_date" AS "start_date"
        FROM "requisition"
        LEFT JOIN "company_department"
          ON "requisition"."company_department_id" = "company_department"."id"
        LEFT JOIN "job_opening"
          ON "requisition"."id" = "job_opening"."job_requisition_id"
        WHERE "requisition"."is_deleted" IS NOT TRUE
          {% if COMPILE_CONTEXT.securityContext.companyId %}
            AND "requisition"."company_id" = {{ COMPILE_CONTEXT.securityContext.companyId }}
          {% endif %}
        ORDER BY COALESCE("job_opening"."id", "requisition"."id")
      )
      /* Final SELECT: JOIN with hiring_team_member for filtering capabilities */
      /* Each opening may appear multiple times (once per hiring team member) */
      /* Measures use count_distinct to ensure correct counts even with duplication */
      SELECT
        uo."requisition_id",
        uo."job_name",
        uo."department_name",
        uo."job_opening_id",
        uo."opening_status",
        uo."filled_date",
        uo."start_date",
        "scalis_user"."first_name" AS "scalis_user_first_name",
        "scalis_user"."last_name" AS "scalis_user_last_name"
      FROM unique_openings uo
      LEFT JOIN "requisition"
        ON uo."requisition_id" = "requisition"."id"
      LEFT JOIN "hiring_team_member"
        ON "requisition"."id" = "hiring_team_member"."requisition_id"
      LEFT JOIN "company_user"
        ON "hiring_team_member"."company_user_id" = "company_user"."id"
      LEFT JOIN "user_invitation"
        ON "company_user"."user_invitation_id" = "user_invitation"."id"
        AND "user_invitation"."deleted_at" IS NULL
      LEFT JOIN "scalis_user"
        ON "user_invitation"."scalis_user_id" = "scalis_user"."id"

    dimensions:
      - name: jobname
        title: 'Job Name'
        sql: 'job_name'
        type: string

      - name: departmentname
        title: 'Department Name'
        sql: 'department_name'
        type: string

      - name: scalisuserfullname
        title: 'Hiring Team Member Name'
        sql: >
          CONCAT(
            COALESCE("scalis_user_first_name", ''),
            ' ',
            COALESCE("scalis_user_last_name", '')
          )
        type: string

    measures:
      - name: timetofilldays
        title: 'Time to Fill (Days)'
        description: 'Average time to fill in days (filled_date - start_date) for filled openings. Note: May have slight imprecision when filtering by hiring team member if different openings have different duplication factors.'
        type: avg
        sql: >
          CASE
            WHEN {CUBE}."opening_status" = 'FILLED'
                 AND {CUBE}."filled_date" IS NOT NULL
                 AND {CUBE}."start_date" IS NOT NULL
            THEN
              {CUBE}."filled_date"::date - {CUBE}."start_date"::date
            ELSE
              NULL
          END
